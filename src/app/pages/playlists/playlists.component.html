<div class="flex justify-content-center w-full">
  <p-message *ngIf="sessionExp" severity="error">
    <b>Session Expired:</b> Please login again. Your information will not be
    carried over so take note of your current position if you are not finished.
    <p-button routerLink="/login" label="Login" />
  </p-message>
  <p-progress-spinner *ngIf="loading" ariaLabel="loading" />
</div>

<div *ngIf="!loading && tracks && tracks.length < 1">
  <p-message severity="info"
    >No Local Tracks Found. Refresh page to start again.</p-message
  >
</div>

<!-- Playlists -->
<div
  *ngIf="playlists && !selectedPlaylist"
  class="flex flex-wrap gap-2 justify-content-center playlist-container mt-4"
>
  <p-card *ngFor="let playlist of playlists.items" [header]="playlist.name">
    <div class="m-auto" style="width: 10em; height: 10em">
      <img
        [src]="playlist.images[0].url"
        class="w-full"
        alt="{{ playlist.name }} image"
      />
    </div>
    <p-accordion
      expandIcon="pi pi-chevron-down"
      collapseIcon="pi pi-chevron-up"
    >
      <p-accordion-panel value="0">
        <p-accordion-header>Description</p-accordion-header>
        <p-accordion-content>
          <p class="m-0">
            {{ playlist.description }}
          </p>
        </p-accordion-content>
      </p-accordion-panel>
    </p-accordion>
    <div class="flex justify-content-center mt-2">
      <p-button [rounded]="true" (click)="setPlaylist(playlist)"
        >Select</p-button
      >
    </div>
  </p-card>
</div>

<!-- Local Songs -->
<div
  *ngIf="selectedPlaylist && tracks && tracks.length > 0 && !loading"
  class="mt-4"
>
  <div class="flex align-items-center">
    <p-menu
      #menu
      [model]="trackJumpOptions"
      [popup]="true"
      styleClass="max-h-10rem overflow-x-scroll"
    />
    Jump To &nbsp;
    <p-button
      variant="outlined"
      severity="contrast"
      (click)="menu.toggle($event)"
      icon="pi pi-angle-double-right"
    />
  </div>
  <div class="flex justify-content-evenly align-items-center gap-1 mb-1">
    <!-- TODO: Back will have an issue on 100 edges -->
    <p-button
      [disabled]="trackPos === 0"
      severity="secondary"
      (click)="trackPos = trackPos - 1; findTrackMatches(tracks[trackPos])"
      label="Back"
    ></p-button>
    <p>{{ allPosition }} / {{ selectedPlaylistTotal }}</p>
    <p-button
      (click)="trackPos = trackPos + 1; findTrackMatches(tracks[trackPos])"
      label="Next"
    ></p-button>
  </div>
  <div
    class="flex gap-1 flex-column align-items-center md:flex-row md:justify-content-around md:align-items-start"
  >
    <span>
      <h5 class="text-center mx-0 my-1 my-1 thin-font">Local Track</h5>
      <p-card [header]="tracks[trackPos].track.name" class="w-20rem">
        <div
          style="width: 10em; height: 10em"
          class="m-auto"
          *ngIf="
            $any(tracks[trackPos].track).album &&
            $any(tracks[trackPos].track).album.images &&
            $any(tracks[trackPos].track).album.images[0]
          "
        >
          <img
            [src]="$any(tracks[trackPos].track).album.images[0].url"
            class="w-full"
            alt="{{ tracks[trackPos].track.name }} image"
          />
        </div>
        <p>
          <b>Artist:</b> {{ $any(tracks[trackPos].track).artists[0].name }}
          <ng-container *ngIf="$any(tracks[trackPos].track).artists.length > 1">
            ft.
            <ng-container
              *ngFor="
                let artist of $any(tracks[trackPos].track).artists;
                first as isFirst
              "
            >
              <ng-container *ngIf="!isFirst">
                {{ artist.name }}
              </ng-container>
            </ng-container>
          </ng-container>
        </p>
        <p><b>Album:</b> {{ $any(tracks[trackPos].track).album.name }}</p>
        <p><b>Year:</b> {{ $any(tracks[trackPos].track).release_date }}</p>
      </p-card>
    </span>
    <span>
      <h5 class="text-center mx-0 my-1 my-1 thin-font">Recommendations</h5>
      <div
        class="flex flex-column gap-2"
        *ngIf="
          trackMatches && trackMatches.items && trackMatches.items.length > 0;
          else noMatches
        "
      >
        <p-card
          *ngFor="let match of trackMatches.items"
          [header]="match.name"
          class="w-20rem"
        >
          <div
            class="m-auto"
            style="width: 10em; height: 10em"
            *ngIf="match.album && match.album.images && match.album.images[0]"
          >
            <img
              [src]="match.album.images[0].url"
              class="w-full"
              alt="{{ match.album.name }} image"
            />
          </div>
          <p>
            <b>Artist:</b> {{ match.artists[0].name }}
            <ng-container *ngIf="match.artists.length > 1">
              ft.
              <ng-container
                *ngFor="let artist of match.artists; first as isFirst"
              >
                <ng-container *ngIf="!isFirst">
                  {{ artist.name }}
                </ng-container>
              </ng-container>
            </ng-container>
          </p>
          <p><b>Album:</b> {{ match.album.name }}</p>
          <p><b>Year:</b> {{ $any(match.album).release_date }}</p>
          <p><b>Explicit:</b> {{ $any(match).explicit }}</p>
          <hr />
          <div class="flex justify-content-center mt-2">
            <p-button [rounded]="true" (click)="replaceTrack(match)"
              >Select</p-button
            >
          </div>
        </p-card>
      </div>
    </span>
    <ng-template #noMatches>
      <div class="flex align-items-center">
        <p-message severity="info">No Matches Found</p-message>
      </div>
    </ng-template>
  </div>

  <!-- Search -->
  <hr />
  <br />
  <div class="flex justify-content-center gap-1 mt-1">
    <p-button
      (click)="searchBox.value = ''; searchMatches = undefined"
      icon="pi pi-undo"
      severity="primary"
      variant="outlined"
      [rounded]="true"
    />
    <p-floatlabel>
      <input
        #searchBox
        pInputText
        id="search"
        (keyup)="search(searchBox.value)"
        (keydown)="searchMatches = undefined"
      />
      <label for="search">Search Spotify</label>
    </p-floatlabel>
  </div>
  <div class="flex justify-content-center w-full">
    <p-progress-spinner *ngIf="searchLoading" ariaLabel="loading" />
  </div>
  <br />
  <div
    class="flex flex-wrap justify-content-center gap-2"
    *ngIf="
      searchMatches && searchMatches.items && searchMatches.items.length > 0;
      else noSearchMatches
    "
  >
    <p-card
      *ngFor="let match of searchMatches.items"
      [header]="match.name"
      class="w-20rem align-items-stretch full-height-card"
    >
      <div class="flex justify-content-between flex-column h-full">
        <div>
          <div
            class="m-auto"
            style="width: 10em"
            *ngIf="match.album && match.album.images && match.album.images[0]"
          >
            <img
              [src]="match.album.images[0].url"
              class="w-full"
              alt="{{ match.album.name }} image"
            />
          </div>
          <p>
            <b>Artist:</b> {{ match.artists[0].name }}
            <ng-container *ngIf="match.artists.length > 1">
              ft.
              <ng-container
                *ngFor="let artist of match.artists; first as isFirst"
              >
                <ng-container *ngIf="!isFirst">
                  {{ artist.name }}
                </ng-container>
              </ng-container>
            </ng-container>
          </p>
          <p><b>Album:</b> {{ match.album.name }}</p>
          <p><b>Year:</b> {{ $any(match.album).release_date }}</p>
          <p><b>Explicit:</b> {{ $any(match).explicit }}</p>
        </div>
        <div class="flex flex-column align-items-center mt-2">
          <hr class="w-full" />
          <p-button [rounded]="true" (click)="replaceTrack(match)"
            >Select</p-button
          >
        </div>
      </div>
    </p-card>
  </div>
  <ng-template #noSearchMatches>
    <div
      class="flex align-items-center w-full"
      *ngIf="
        searchBox.value.trim() &&
        !searchLoading &&
        searchMatches &&
        searchMatches.items &&
        searchMatches.items.length < 1
      "
    >
      <p-message severity="info">No Search Matches Found</p-message>
    </div>
  </ng-template>
</div>
